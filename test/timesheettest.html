<!DOCTYPE html>
<html>

<head>
    <title>NOVA</title>
    <meta property="og:image" content="">
    <meta property="og:type" content="website">
    <meta property="og:title" content="NOVA Timesheet">
    <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Noto Sans' rel='stylesheet'>
    <style>
        body {
            font-family: 'Montserrat';
        }

        h1 {
            font-size: 30px;
        }

        input {
            font-family: 'Noto Sans';
            margin-right: 5%;
        }
    </style>
</head>

<body>
    <h1>
        NOVA
    </h1>
    <form id="info-group" action="">
        <label for="name">Name: </label>
        <input name="name" id="name" type="text" />
        <label for="name">Date: </label>
        <input name="date" id="date" type="date" />
        <input name="submit-date-time" id="submit-date-time" type="text" readonly="true" hidden="true" />
        <input name="finalRowIndex" id="finalRowIndex" type="number" readonly="true" hidden="true" />

        <table id="timesheet">
            <th>Project</th>
            <th>Task</th>
            <th>Hour Spent</th>
            <th>Description</th>
            <th>...</th>
        </table>

        <button onclick="addRow()" id="addRowButton" type="button">Add Row</button>
        <button onclick="submitForm()" id="submitButton" type="button">Submit</button>
    </form>

    <!-- Add row to the timesheet table -->
    <script>
        globalThis.currentRowIndex = 0;
        function addRow() {
            const table = document.getElementById("timesheet");
            const row = document.createElement("tr");
            const cell1 = document.createElement('td');
            const cell2 = document.createElement('td');
            const cell3 = document.createElement('td');
            const cell4 = document.createElement('td');
            const cell5 = document.createElement('td');

            const optionList = [
                '<option value="yx_community">Y.X Community</option>',
                '<option value="cm">Central Market</option>',
            ]
            const options = optionList.join("");

            cell1.innerHTML = '<input type="text" name="row1" id="row1" />';
            cell2.innerHTML = '<select name="row2" id="' + currentRowIndex + '">' + options + '</select>';
            cell3.innerHTML = "Cell3";
            cell4.innerHTML = "Cell4";
            cell5.innerHTML = "Cell5";

            row.appendChild(cell1);
            row.appendChild(cell2);
            row.appendChild(cell3);
            row.appendChild(cell4);
            row.appendChild(cell5);
            table.appendChild(row);
            console.log("Current Row Index: " + row.rowIndex);
            globalThis.currentRowIndex = row.rowIndex;
            document.getElementById("finalRowIndex").value = row.rowIndex;
        }
    </script>

    <!-- Default the date field as today -->
    <script>
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var yyyy = today.getFullYear();
        var time = String(today.getHours()).padStart(2, '0') + ":" + String(today.getMinutes()).padStart(2, '0');
        currentDay = yyyy + "-" + mm + "-" + dd;
        currentDateTime = currentDay + " " + time;
        document.getElementById("date").value = currentDay;
        document.getElementById("submit-date-time").value = currentDateTime;
        function submissionDateTime() {
            return currentDateTime;
        }
    </script>

    <!--- Add staff name from URL to Name field -->
    <script>
        const queryString = new Proxy(new URLSearchParams(window.location.search), {
            get: (searchParams, prop) => searchParams.get(prop),
        })
        const staff = queryString.staff;
        if (staff) {
            const staffNameArray = staff.split("_");
            staffNameArray.forEach(arrayFirstCharToUppercase);
            const staffName = staffNameArray.join(" ");
            document.getElementById("name").value = staffName;
        }
        function arrayFirstCharToUppercase(item, index, arr) {
            let itemArray = item.split("");
            itemArray[0] = itemArray[0].toUpperCase();
            arr[index] = itemArray.join("");
        }
    </script>

    <!-- Submit form -->
    <script>
        function submitForm() {
            const nameValue = document.getElementById("name").value;
            const dateValue = document.getElementById("date").value;
            const submitDateTimeValue = submissionDateTime();
            const finalRowIndexValue = document.getElementById("finalRowIndex").value;
            if (nameValue && dateValue && finalRowIndexValue) {
                postWebhook(nameValue, dateValue, submitDateTimeValue, finalRowIndexValue);
            } else {
                alert("Please enter your Name and the Date, or add a row. ");
            }
        };

        function postWebhook(namePush, datePush, submitPush, rowIndexPush) {
            const request = new XMLHttpRequest();
            const url = "https://hooks.zapier.com/hooks/catch/4265169/3olh63w/";
            const body = {
                "name": namePush,
                "date": datePush,
                "submissionDateTime": submitPush,
                "rowIndex": rowIndexPush
            };
            request.open("POST", url);
            request.onreadystatechange = function () {
                if (request.readyState == 4 && request.status == 200) {
                    //Add redirect logic here
                } else {
                }
            }
            try {
                request.send(JSON.stringify(body));
            } catch (err) {
                alert("2: " + err);
            }
        };
    </script>

</body>

</html>